YUI.add("mail-ui-folderevents",function(A){A.namespace("mail.ui");var Q=A.mail.Controller.Folders,I=A.common.ui.DialogHelper,B=A.common.Utils,G=B.substitute,O=A.Lang.trim,M={};function K(a,W,X){var Y,b={success:function(c){Y.destroy();if(a){a(c.folderInfo);}A.fire("foldersModified");},failure:function(c){var e=R(c.reason,c.fault),d=A.one("#newFolderErr");d.one("ul").one("li").setContent(e.text);d.setStyle("display","block");d.removeClass("hidden");d.focus();},suppressCodes:["*"]},T=function(c){var d=A.one("#newFolder");d.select();if(NeoConfig.bidi){d.plug(A.Plugin.BidiTextEntry);}d.on("keydown",function(f){if(f.keyCode==13){c.fire("dialog:action",{dataAction:"ok",item:d});}});c.set&&c.set("adAction","disableRetriggerOnOk");Y=c;},Z,V,U;A.use("_shared_module_offscreen_bin_shell_navigation_newfolder_body_rollup","_shared_module_offscreen_bin_shell_navigation_newfolder_header_rollup","modal_css","forms_css",function(c){V=c.ui.Templates._shared_module_offscreen_bin_shell_navigation_newfolder_body_rollup;Z=c.ui.Templates._shared_module_offscreen_bin_shell_navigation_newfolder_header_rollup;U={folder_dialog_title:function(){return(W==="move"?strings.str_modal_foldername_move_title:strings.str_modal_foldername_title);}};I.confirm({hd:G(Z.base,0,U,0,strings),bd:G(V.base,0,0,0,strings),focusedNode:"#newFolder",restoreFocusNode:null},{ok:{handler:function(){Q.create(c.one("#newFolder").get("value"),b,W);},stopDestroy:1},cancel:{handler:function(){var d=c.after("dialog:hide",function(){try{d.detach();X.focus();}catch(f){}});}}},T);});A.fire("darlaEvent",{action:"lftpane_add_folder"});}function S(V){var T=strings.str_modal_folder_delete_title,W={failure:function(X){var Y,Z=X.fault?X.fault:"";if(Z&&Z.detail&&Z.detail[0]){Y=Z.detail[0].code;if(Y=="ymws:Client.FolderNotEmpty"){I.alert({hd:T,bd:strings.str_modal_folder_delete_note});}if(Y=="ymws:Client.FolderIdDoesntExist"){Q.refresh();}}},suppressCodes:["Client.FolderNotEmpty","Client.FolderIdDoesntExist"]},U=function(X){var Y=A.mail.FoldersView.get("fid");if(V==Y.fid){X.set&&X.set("adAction","disableRetriggerOnOk");}};Q.get(V,{success:function(X){if(X.total==0){function Y(){var Z=A.one("#"+V).previous().get("id");A.mail.FoldersView.set("fid",{fid:Z,name:Z});}I.confirm({hd:T,bd:G(strings.str_modal_folder_delete_question,{foldername:NeoConfig.bidi&&X.folderInfo.dir?'<span dir="'+X.folderInfo.dir+'">'+X.folderInfo.name+"</span>":X.folderInfo.name},0,0,0)},{ok:{handler:function(){Q.remove(V,W);A.fire("foldersModified");}},cancel:{handler:function(){try{A.one("li[data-fid="+V+"] a").focus();}catch(Z){}}}},U);}else{I.alert({hd:T,bd:strings.str_modal_folder_delete_note});}}});}function F(X){var V=A.one("#renamer"),U=V.get("value"),T;P();function W(Y){var a=R(Y.reason,Y.fault);function Z(){if(V.getStyle("display")!="none"){D(V,X);V.select();}}if(a){I.alert({hd:a.title,bd:a.text,restoreFocusNode:V},{ok:{handler:Z},cancel:{handler:Z}});}else{U=X.name;L(V,U,X);}}if(O(X.name)!=O(U)){T={success:function(){L(V,U,X);},failure:W,suppressCodes:["*"]};Q.rename({fid:X.fid,name:U},T);}else{L(V,U,X);}}function L(U,T,W){var V=W.foldersDiv.one('[data-fid="'+W.fid+'"] i');W.shimEl.setStyle("display","none");U.setStyle("display","none");V&&V.set("text",O(T));U.set("value",T);P();}function P(){M.key.detach();M.blur.detach();}function D(U,V){var T;M.key=U.on("keydown",function(W){T=W.keyCode;switch(W.keyCode){case 27:L(U,V.name,V);break;case 13:case 9:F(V);W.halt();break;case 65:if(W.ctrlKey||W.metaKey){A.one("#renamer").select();}break;}});M.blur=U.on("blur",function(){if(T!==27){F(V);}});}function H(T){var U=A.Node.create('<div id="shimEl"></div>');U.setStyles({position:"absolute",top:"0",left:"0",height:"100%",width:"100%",backgroundColor:"red",opacity:"0",zIndex:T.zIndex-1||3099,display:"none"});A.one("body").prepend(U);return U;}function E(T){A.use("_shared_module_offscreen_bin_renamer",function(U){var d=T.target,V=d.one("i"),Z=d.one("span.rht"),f=d.ancestor(".items-nav"),c=U.one("body"),W={fid:d.getAttribute("data-fid"),foldersDiv:f,name:V.get("text"),renameParent:c,shimEl:U.one("#shimEl")||null,zIndex:3100},X=c.one("#renamer"),b=U.one("#menu-folder");if(!d.hasClass("selected")){U.mail.FoldersView.set("fid",{fid:W.fid,name:W.name});}if(!X){c.prepend(U.ui.Templates._shared_module_offscreen_bin_renamer.base);X=c.one("#renamer");X.setStyle("display","none");if(NeoConfig.bidi){X.plug(U.Plugin.BidiTextEntry);}X.on("click",function(Y){Y.halt();});}if(!W.shimEl){W.shimEl=H(W);}if(X.getStyle("display")=="none"){X.set("value",W.name);if(b){b.setStyle("display","none");}var e=strings.str_tog_loadRTLCss?"right":"left",a={display:"block",position:"absolute",zIndex:W.zIndex,top:V.getY()+"px",width:((d.get("offsetWidth")-Z.get("offsetWidth"))/2)+"px"};a[e]="32px";X.setStyles(a);V.set("innerHTML","&nbsp;");U.Lang.later(0,null,function(){D(X,W);X.focus();X.select();U.fire("foldersModified");});W.shimEl.setStyle("display","block");}});}function N(V,U){var T=A.mail.FoldersView;Q.empty(V,null);if(V=="Trash"){A.fire("darlaEvent",{action:"empty_trash"});T.set("fid",{fid:V,name:strings.str_tabs_trash});}else{if(V=="%40B%40Bulk"){A.fire("darlaEvent",{action:"empty_spam"});T.set("fid",{fid:V,name:strings.str_tabs_spam});}}}function J(Y,V,X){var T,W,U=function(){A.mail.ui.FolderEvents.emptyAction(Y,X);};switch(Y){case"Trash":T=strings.str_nav_empty_trash;W=strings.str_empty_trash_conf;break;case"%40B%40Bulk":T=strings.str_nav_empty_spam;W=strings.str_empty_spam_conf;break;default:T=G(strings.str_nav_empty_folder,{foldername:X});W=G(strings.str_empty_folder_conf,{foldername:X});break;}I.confirm({hd:T,bd:W,restoreFocusNode:(V?A.one("li[data-fid="+Y+"] a"):null),hasfetchAdsInCbk:NeoConfig.intl==="jp"},{ok:{handler:U}},function(Z){Z.set&&Z.set("adAction","disableRetriggerOnOk");});}function C(T,U){A.use("mail-ui-messageevents",function(W){var V=W.mail.model.DataStore.Folders.get(U);T.numMid=V.unread||0;W.mail.ui.MessageEvents.handleUI(T,U);});}function R(V,U){var W=Q.Error,T={title:strings.str_branding_mail,text:""};
if(U&&U.detail&&U.detail[0]){switch(U.detail[0].code){case"ymws:Client.FolderNameIllegalCharset":T.text=strings.str_modal_foldername_err_badcharset;return T;case"ymws:Client.TooManyFolders":T.text=strings.str_error_TooManyFolders;A.use("rocket-stats",function(X){B.rocketstats.stat("folders","tooManyFolders");});return T;case"ymws:Client.FolderNameNotAllowed":case"ymws:Client.FolderNameExists":V=W.exists;break;case"ymws:Client.FolderIdDoesntExist":T.text=strings.str_error_FolderIdDoesntExist;return T;}}switch(V){case W.empty:T.text=strings.str_modal_foldername_err_empty;break;case W.oversize:T.text=strings.str_modal_foldername_err_length;break;case W.exists:T.title=strings.str_modal_folder_exists_title;T.text=strings.str_modal_foldername_err_duplicate;break;case W.baddata:T.text=strings.str_modal_foldername_err_invalid;break;default:T.text=strings.str_modal_generic_err;}return T;}A.mail.ui.FolderEvents={handle:function(T,W){T=T||{};var U=T.dataAction,V;switch(U){case"folder-new":K(null,null,T.target);break;case"folder-rename":E(T);break;case"folder-remove":S(W);break;case"folder-allread":T.action=U;C(T,W);break;case"folder-empty":V=T.target&&T.target.one("i");if(V&&V.getContent()){J(W,T.restoreFocus,V.getContent());}break;case"folder-empty-spam":J("%40B%40Bulk",T.restoreFocus);break;case"folder-empty-trash":J("Trash",T.restoreFocus);break;}},createFolder:K,getFolderNameError:R,emptyAction:N};if(NeoConfig.intl==="jp"){A.use("mail-ui-folderevents-jp",function(T){T.mail.ui.FolderEvents.emptyAction=T.mail.ui.FolderEventsJp.emptyAction;});}},"1.0.0",{requires:["common-utils","mail-controller-folders","common-ui-dialog-helper","comms-bidi-textentry"]});