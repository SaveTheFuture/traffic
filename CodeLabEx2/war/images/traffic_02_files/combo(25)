YUI.add("mail-ui-messageevents",function(B){B.namespace("mail.ui");var T=B.mail.Controller.Messages,D=B.common.Utils,N=B.comms&&B.comms.Utils,Q=B.common.ui,V=[],G,C=NeoConfig,g=strings.str_cfg_tog_flag_spam_on_move,X=C.grayoutEnabled;function e(h){var Y=B.mail.ui.ContextButton;return Y?Y.buttonEnabled(h):1;}function f(h,i,Y){Y=Y||{};Y.header=strings.str_delete;Y.dlgHandle=Y.dlgHandle||{};Y.dlgHandle.abortHandle=T.remove({fid:i,mid:h},M(Y));}function R(j,h,i,Y){if(j=="%40C%40Chats"){return;}Y=Y||{};Y.header=strings.str_move;Y.dlgHandle=Y.dlgHandle||{};Y.totalMsgs=(i)?i.length:0;Y.dlgHandle.abortHandle=T.move({sourceFid:j,destinationFid:h,mid:i},M(Y));}function Z(k,n,j,Y){var m,i,l={},h;Y=Y||{};Y.header=O(k).name;Y.dlgHandle=Y.dlgHandle||{};Y.totalMsgs=(j)?j.length:0;if(!Y.hasMsgList&&j){h=j[0]&&j[0].mid;if(B.Array.indexOf(V,h)>=0){return;}Y.mid=h;V.push(h);}switch(k){case"unread":l.read=0;break;case"unflagged":l.flagged=0;break;case"notspam":l.ham=1;break;case"spam":l.spam=1;if(strings.str_cfg_tog_set_spam_read_flag){l.read=1;}B.fire("darlaEvent",{action:"mark_spam"});break;default:l[k]=1;break;}m={fid:n,mid:j,setFlags:l};if(k==="notspam"&&Y.fid!=="%40B%40Bulk"&&g){m.destFid=Y.fid;}if(i=Y.selection){m.selection=i;}Y.dlgHandle.abortHandle=T.flag(m,M(Y));}function M(Y){return{suppressCodes:["Client.MessageIdsNotFound"],success:function(){var h=B.common.ui.Notification;if(h){h.msgNotification({action:Y.action,totalMsgs:Y.totalMsgs,fid:Y.fid});}if(!Y.hasMsgList){V.splice(B.Array.indexOf(V,Y.mid),1);}Y.widget&&Y.widget.vlist&&Y.widget.vlist.clear();if(Y.dlgHandle&&Y.dlgHandle.destroy){Y.dlgHandle.destroy();}if(strings.str_cfg_tog_timed_alert_dialog){B.use("mail-ui-message-timedalertdialog",function(i){i.mail.ui.messageTimedAlertDialogRender(Y);});}},failure:function(){if(!Y.hasMsgList){V.splice(B.Array.indexOf(V,Y.mid),1);}if(Y.dlgHandle&&Y.dlgHandle.destroy){Y.dlgHandle.destroy();}},progress:function(h){if(h.processed==0&&!(Y.dlgHandle&&Y.dlgHandle.destroy)){P(Y);}else{if(Y.dlgHandle&&Y.dlgHandle.get){Y.dlgHandle.get("contentBox").one("div.prog-indicator div.progress").setStyle("width",Math.floor((h.processed*100)/h.total)+"%");}}}};}function P(h,Y){B.use("attachments_css","common-ui-dialog-helper","_shared_module_offscreen_bin_progress_bar",function(n){var j=D.substitute,k=n.ui.Templates,i=n.common.ui.DialogHelper,l={cancel:{handler:function(){var p=h.dlgHandle||{};if(p.abortHandle&&p.abortHandle.abort){p.abortHandle.abort();}h.aborted=1;}}},m={},o={"delete":true,"spam":true,"notspam":true,"trash":true,"inbox-move":true,"move":true};m.hd=h.header;m.bd="<br /><br />"+j(k._shared_module_offscreen_bin_progress_bar.base,0,0,0,{progress:"0"});i.cancelDialog(m,l,function(p){if(h.dlgHandle&&h.dlgHandle.abortHandle){p.abortHandle=h.dlgHandle.abortHandle;}if(NeoConfig.fullPage&&o[h.action]){p.set&&p.set("adAction","disableRetriggerOnHide");}h.dlgHandle=p;h.aborted=0;if(Y){Y(p);}});});}function H(j,Y,i,k){var q=B.ui.Templates,p=Y.get("selectCount"),o="",h="",m="",l=strings.str_modal_message_delete_num_question,n;if(j==="%40B%40Bulk"){h="default";l=strings.str_empty_spam_conf;}else{if(j==="Trash"){l=strings.str_empty_trash_conf;}m="default";}if(p){o=p.toString();}n=D.substitute(l,0,0,0,{num_selected:o});B.use("common-ui-dialog-helper","_shared_module_offscreen_bin_modal_btn_generic",function(v){var w=D.substitute(q._shared_module_offscreen_bin_modal_btn_generic.base,0,0,0,{btnID:"ok","default":h,btnLabel:strings.str_ok}),s=D.substitute(q._shared_module_offscreen_bin_modal_btn_generic.base,0,0,0,{btnID:"cancel","default":m,btnLabel:strings.str_btn_cancel}),u={hd:strings.str_modal_message_delete_all_title,bd:n,ft:w+s,hasfetchAdsInCbk:C.intl==="jp"},t={ok:{handler:function(){i();}},cancel:{handler:function(){k&&k();}}},r=function(x){x.set&&x.set("adAction","disableRetriggerOnOk");};v.common.ui.DialogHelper.createCommon(u,t,r);});}function I(h,Y,i){var j=h&&h.get&&h.get("selectCount");d("str_modal_message_delete_title",(typeof j!="number"||j===1)?"str_modal_message_delete_single_question":"str_modal_message_delete_question",Y,i);}function d(j,i,Y,h){B.use("common-ui-dialog-helper",function(){Q.DialogHelper.confirm({hd:strings[j],bd:strings[i]},{ok:{handler:function(){Y();}},cancel:{handler:function(){h&&h();}}});});}function a(Y,l,m,j){var h=["open","forward","reply_sender","reply_all","edit","fullheader","addcontact","set_encodings","print","reply-im","reply-sms","quick_filter"],k=B.Array.indexOf(h,l)!==-1,i=m==="%40C%40Chats";if(Y==1||(Y>1&&!k)){return 0;}if(X&&j){return !e(j);}B.use("common-ui-dialog-helper",function(){if(Y==0){Q.DialogHelper.alert({hd:strings.str_modal_no_msg_title,bd:strings[i?"str_modal_zero_selected_conv":"str_modal_zero_selected"]});}else{if(Y>1){Q.DialogHelper.alert({hd:strings.str_modal_too_many_msgs_title,bd:strings[i?"str_modal_select_single_message_conv":"str_modal_select_single_message"]});}}});return 1;}function F(Y,h){B.use("common-ui-dialog-helper",function(i){T.fullHeader({fid:h,mid:Y[0].mid},{success:function(j){Q.DialogHelper.alert({modal_classes:"lg",hd:strings.str_modal_full_header,bd:['<textarea readonly="true" style="width:100%;height:25em;" class="default">',j?D.escapeHtml(j.rawheaders[0]):strings.str_error_no_body_returned,"</textarea>"].join(""),focusedNode:".default"});},failure:function(){Q.DialogHelper.alert({hd:strings.str_modal_full_header,bd:strings.str_error_no_body_returned});}});});}function J(Y,i,h){B.use("common-ui-dialog-helper","modal_css",function(q){var l=q.common.persist.UserData;var o=l.get("userSendPref");var k={name:"",email:""};if(o){k.name=o.defaultFromName;k.email=o.defaultFromAddress;}var p=[];for(var j=0;j<Y.length;j++){p.push(Y[j].mid);}var n=[];n.push({email:h});T.redirectMsg({fid:i,mid:p,resentFrom:k,resentTo:n},{success:function(){Q.DialogHelper.alert({hd:"Redirect Messages",bd:"Message redirection <b>successful.</b>"});},failure:function(){Q.DialogHelper.alert({hd:"Redirect Messages",bd:"Message redirection <b>failed.</b>"});}});});}function W(Y){B.use("common-ui-dialog-helper",function(){Q.DialogHelper.confirm({hd:"Redirect messages",bd:'Redirect to: &nbsp; <input id="redirectMsg" class="field-name " type="text" size="30" value="buggy_messages@yahoo.com" name="redirectMsg">'},{ok:{handler:function(i,h){Y();
h.destroy();},stopDestroy:true}});});}function L(Y,h){B.use("mail-ui-message-encodings",function(i){i.mail.ui.MessageEncodings.setMessageEncoding(Y,h);});}function O(i){var Y=strings.str_move,h={"delete":{op:"remove",name:strings.str_delete},spam:{op:"spam",name:strings.str_spam},notspam:{op:"spam",name:strings.str_not_spam},read:{op:"flag",name:strings.str_menu_mark_read},unread:{op:"flag",name:strings.str_menu_mark_unread},flagged:{op:"flag",name:strings.str_menu_flag},unflagged:{op:"flag",name:strings.str_menu_clear_flag},trash:{op:"move",name:Y},"inbox-move":{op:"move",name:Y},"folder-new":{op:"move",name:Y},move:{op:"move",name:Y}};return h[i];}function c(j,l,i,k){if(k){b(j,k,l);}else{if(i){var h=O(j.action),Y=i.get("selectCount");if(A(h,Y)){B.mix(j,{dlgHandle:null,header:h.name});j.widget=i;P(j,function(){i.getSelected(function(m){b(j,m,l);});});}else{i.getSelected(function(m){b(j,m,l,i);});}}}if(j.afterHandle){j.afterHandle(j.afterHandleParams);}}function A(Y,i){var h,j;if(Y&&(h=T.bulkOps[Y.op])){if(j=h.fixed){return i>=j*2.5;}else{return 2*h.bs<=i;}}}function U(i,k){var Y=O(i.action),h=i.numMid||0,j;if(h==0){return;}if(A(Y,h)){j={fid:k,numMid:h};i.filterBy&&B.mix(j,i.filterBy);B.mix(i,{dlgHandle:null,header:Y.name});P(i,function(){T.list(j,{success:function(l){b(i,l.mid,k);}});});}else{b(i,null,k);}if(i.afterHandle){i.afterHandle();}}function E(h,Y){B.use("mail-ui-print",function(){B.mail.ui.print({fid:Y,msg:h});});}function S(p,k,Y,q){var m,n,r,j,h,o,l=false;G=G||B.one("#pagetoolbar");p=p||{};m=p.action;p.root=G;p.cancelCbk=p.cancelCbk||0;if(m=="delete"&&(n=B.mail.model.DataStore.Folders.get(k))&&n.total==0&&!n.isSystem&&!X){B.use("mail-ui-folderevents",function(i){i.mail.ui.FolderEvents.handle({dataAction:"folder-remove"},k);});return;}if((m!=="menu"&&m!=="move-menu")&&(!q&&Y&&a(Y.get("selectCount"),m,k,p))){return;}switch(m){case"delete":case"trash":if(k=="Draft"){Y.getSelected(function(i){for(o=0;o<i.length;o++){h=i[o];j=B.mail.Tabs.getTab(function(s){return s.type&&s.type==="author"&&s.matchOrigin({oMsg:h,fid:k,action:"delete"});});if(j){B.use("common-ui-dialog-helper",function(){Q.DialogHelper.alert({hd:strings.str_branding_mail,bd:strings.str_modal_delete_open_draft});});l=true;return;}}});if(l){return;}}if(Y&&Y.selectAllNode.get("checked")&&Y.get("selectCount")!=1){H(k,Y,function(){c(p,k,Y,q);});}else{if((m=="delete")&&((k=="Trash")||(k=="%40B%40Bulk")||(k=="%40C%40Chats"))){I(Y,function(){c(p,k,Y,q);},p.cancelCbk);}else{c(p,k,Y,q);}}break;case"folder-new":B.use("mail-ui-folderevents","mail-controller-folders",function(i){i.mail.ui.FolderEvents.createFolder(function(s){s.action=s.action||"folder-new";r=function(){c(s,k,Y,q);};if(p.preHandle){p.preHandle(r);}else{r();}},"move");});break;case"redirectmsg":W(function(){c(p,k,Y,q);});break;case"folder-allread":p.action="read";p.filterBy={"filterBy-isRead":0};p.selection={isRead:0};U(p,k);break;default:c(p,k,Y,q);break;}}function b(q,s,l,Y){q=q||{};var m=q.action,r=/[\s\S]+"cloud_id":(\d+)[\s\S]+/,n,o,i,h,p,k,j;if(q.aborted){return;}if(strings.str_cfg_tog_edit_draft_from_search&&m==="open"&&s[0].sourceFolderInfo.fid=="Draft"){m="edit";}if(q.tbAction){q.noScroll=true;}if(m==="move"&&g){if(q.fid==="%40B%40Bulk"){q.action=m="spam";}else{if(l==="%40B%40Bulk"){q.action=m="notspam";}}}switch(m){case"delete":f(s,l,q);break;case"open":if(Y&&Y.sortedColumn&&(n=Y.vlist)&&n.arrItems){B.fire("openMessage",{msg:s[0],fid:l,noScroll:q.tbAction,sortCol:Y.sortedColumn,arrMsgSeq:n.arrItems,index:(n.rootSelect&&n.rootSelect.index)||null});}else{B.fire("openMessage",{msg:s[0],fid:l,noScroll:q.tbAction});}break;case"forward":B.fire("newMessage",B.mix(q,{fid:l,oMsg:s[0]}));break;case"forward_as_attachment":q.action="forward";q.forwardAsAttachment=true;B.fire("newMessage",B.mix(q,{fid:l,oMsg:s[0]}));break;case"reply_sender":B.fire("newMessage",B.mix(q,{fid:l,oMsg:s[0]}));break;case"reply_all":B.fire("newMessage",B.mix(q,{fid:l,oMsg:s[0]}));break;case"reply-im":K("IM",s[0]);break;case"reply-sms":if(NeoConfig.tog_hasSMS){K("Sms",s[0]);}break;case"edit":B.fire("editMessage",B.mix(q,{fid:l,oMsg:s[0]}));break;case"spam":case"notspam":case"read":case"unread":case"flagged":case"unflagged":Z(m,l,s,q);break;case"trash":R(l,"Trash",s,q);break;case"inbox-move":R(l,"Inbox",s,q);break;case"folder-new":R(l,q.fid,s,q);break;case"move":R(l,q.fid,s,q);break;case"move-menu":B.fire("toolbar:ui-automation","menu","move");break;case"fullheader":F(s,l);break;case"addcontact":i=s[0];if(l=="%40C%40Chats"){p=i.clickedAddress||i.header.from.email||"";h=i.clickedName||i.header.from.name||"";o=[];if(p==="mailbot@yahoo.com"&&(/^\d+$/).test(h)){o.push({type:"phone",value:h,flags:["MOBILE"]});}else{o.push({type:"name",value:N&&N.splitName&&N.splitName(h)});o.push({type:"email",value:p});k=i.body?r.exec(i.body.display):(C.msgrData&&C.msgrData.reply&&["",C.msgrData.reply.cloud_id]);j={1:"LCS",2:"MSN",9:"IBM"};if(k&&k[1]&&j[k[1]]){o.push({type:"otherid",value:p,flags:[j[k[1]]]});}else{o.push({type:"yahooid",value:p.replace(/@yahoo\.(.+)/,function(u,t){return(t=="cn")?u:"";})});}}}else{if("msg"===q.context){p=i.header.from.email||"";h=i.header.from.name||"";}else{p=i.clickedAddress||"";h=i.clickedName||"";}}B.fire("addContact",h,p,o);break;case"set_encodings":L(s,l);break;case"redirectmsg":J(s,l,document.getElementById("redirectMsg").value);break;case"print":E(s[0],l);break;case"quick_filter":B.use("mail-ui-messagesview-quickfilter",function(t){t.mail.ui.QuickFilter.createDialog({msgHeader:s[0].header});});break;}}function K(h,j){var i=j,m=i.header||{},l=m.from||{},k=l.email||"",Y=NeoConfig.msgrData.reply||{};if(k=="mailbot@yahoo.com"){k=l.name;Y.id=k;Y.network="sms";Y.cloud_id=undefined;NeoConfig.msgrData.reply=Y;}if((h=="IM")&&(k.indexOf("@")<0)){k+="@yahoo.com";}if(k){B.fire("chats:send"+h,{id:k});}}B.mail.ui.MessageEvents={getDataActionInfo:O,createProgressDialog:P,handleUI:S,handle:b};},"1.0.0",{requires:["mail-controller-messages","mail-controller-messages-ops","common-utils","common-ui-tabs-base","mail-model-datastore","comms-utils"]});
