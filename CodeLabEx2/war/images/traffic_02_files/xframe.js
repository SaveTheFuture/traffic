YUI.add("xframe",function(C){var B=1000;function A(D){A.superclass.constructor.apply(this,arguments);}A.NAME="yim-xframe";A.ATTRS={api:{value:""},proxy:{value:""},localRelay:{value:""},remoteRelay:{value:""},isProxy:{value:false},logoutURL:{value:"",setter:function(D){if(D&&D!=""&&!this._unloadHandler){if(window.addEventListener){window.addEventListener("unload",C.bind(this._logoutOnUnload,this),false);}else{window.attachEvent("onunload",C.bind(this._logoutOnUnload,this));}this._unloadHandler=true;}return D;}},xframePath:{value:""},yuiPath:{value:""}};C.extend(A,C.Base,{initializer:function(D){var I=this.get("isProxy"),G=this.genKey();var J=window.postMessage?"wpm":"ifh";this.set("transport",J);this._iframe_loaded=false;this.set("localKey",G);var F=I?"message":YUI.guid("msg_");this.localId=F;this._listeners=[];this._parseTimers=[];this._pendingRequests={};this.chunks=[];this.chunkCount=0;this._boundReceive=C.bind(this._receive,this);if(window.addEventListener){window.addEventListener("message",this._boundReceive,false);}else{window.attachEvent("onmessage",this._boundReceive);}YUI.Env.globalEvents.on(F,this._boundReceive);this._cbs={};this._cbid=0;this._sendQueue=[];this._iframePool=[];this._connectionEstablished=false;if(I){var E=location.href.split("#")[1].split("*");this.set("remoteKey",E[0]);this.set("api",E[1]);this.set("remoteRelay",E[2]);this.set("remoteId",E[3]);this.domainCheck();this.__send(C.JSON.stringify({token:G,key:this.get("remoteKey")}),parent,this.get("remoteId"),this.get("otherDomain"));}else{this.set("proxyName",YUI.guid());this._url=[this.get("proxy"),"#",G,"*",this.get("api"),"*",this.get("localRelay"),"*",this.localId,"*y=",this.get("yuiPath"),"*","xframePath=",this.get("xframePath")].join("");var H=this.emitInvisibleIframe(this._url,this.get("proxyName"));this.set("iframe",H);}},genKey:function(){return(this.get("isProxy")?"proxy":"main")+"_"+Math.floor(1000000000000000000*Math.random()).toString(36);},destructor:function(){var E=null,G,D,F;this._destroyed=true;if(this.iframe_load_timeout){this.iframe_load_timeout.cancel();this.iframe_load_timeout=null;}if(this.iframe_onloadfired_timeout){this.iframe_onloadfired_timeout.cancel();this.iframe_onloadfired_timeout=null;}while(this._parseTimers.length>0){this._parseTimers.pop().cancel();}while(this._iframePool.length>0){E=this._iframePool.pop();this._destroyIframe(E);}for(G in this._pendingRequests){if(this._pendingRequests.hasOwnProperty(G)){F=this._pendingRequests[G].request;D=this._pendingRequests[G].timer;if(D){clearTimeout(D);}if(F){F.onreadystatechange=null;}}}delete this._requestTimers;E=this.get("iframe");if(E){this._destroyIframe(E);}while(this._listeners.length){this._listeners.pop().detach();}},parseURI:function(H){var J=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,F=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],I=/(?:^|&)([^&=]*)=?([^&]*)/g,D=J.exec(H),G={queryKey:{}},E=F.length;while(E--){G[F[E]]=D[E]||"";}G.query.replace(I,function(L,K,M){if(K){G.queryKey[K]=M;}});return G;},domainCheck:function(){if(this.get("otherDomain")){return;}var H=this.get("remoteRelay"),F=this.parseURI(H),E=F.host,D=[".flickr.com",".yahoo.com"];while(D.length){var G=D.shift();if(E.substr(E.length-G.length)===G){this.set("otherDomain",F.protocol+"://"+F.host);return;}}throw new Error("Unknown origin domain: "+E);},send:function(I,E,D,H,F){if(this._fatalError){H({error:{code:701,detail:"Xframe initialization error"}});return;}var G=this.get("proxyWindow");if(!G){this._sendQueue.push({method:I,url:E,body:D,callback:H,timeout:F});}else{return this._send(I,E,D,H,F);}},_send:function(K,F,D,J,H){var E=++this._cbid,I=C.JSON.stringify({cbid:E,method:K,url:F,body:D,key:this.get("remoteKey"),timeout:H});this._cbs[E]=J;if(this.get("proxyWindow")){this.__send(I,this.get("proxyWindow"),null,this.get("proxy"));}else{var G=this;setTimeout(function(){G.__send(I,G.get("proxyWindow"),null,G.get("proxy"));},8000);}},_receive:function(H){if(H._event&&!H.data){H.data=H._event.data;H.source=H._event.source;}if(H.total>0){this.chunks[H.index]=H.data;this.chunkCount++;if(this.chunkCount==H.total){H.data=this.chunks.join("");this.chunks=[];this.chunkCount=0;}else{return;}}var F=this.get("isProxy"),G={},E=this,I=H.source;G=C.Lang.trimLeft(H.data);if(!G.length||(G.charAt(0)!=="{"&&G.charAt(0)!=="[")){return;}try{G=C.JSON.parse(H.data);}catch(D){G={};}this._parseTimers.push(C.later(0,this,function(){if(this._destroyed||!G||G.key!==this.get("localKey")){return;}if(F){if(!C.Lang.isUndefined(G.logoutURL)){this.set("logoutURL",G.logoutURL);}else{if(G.command&&G.command=="cancelRequests"){this._cancelRequests();}else{this.ajax(G.method,G.url,G.body,function(O){var N=C.JSON.stringify({cbid:G.cbid,text:O,key:E.get("remoteKey")});E._parseTimers.push(C.later(0,E,function(){if(!this._destroyed){this.__send(N,I,I,this.get("otherDomain"));}}));},G.timeout);}}}else{if(G.token){this._connectionEstablished=true;if(this.iframe_load_timeout){this.iframe_load_timeout.cancel();this.iframe_load_timeout=null;}this.set("remoteKey",G.token);this.domainCheck();this.set("proxyWindow",this.get("iframe").contentWindow);while(this._sendQueue.length){var J=this._sendQueue.shift();this._send(J.method,J.url,J.body,J.callback,J.timeout);}}else{var M=this._cbs[G.cbid],L=G.text;delete this._cbs[G.cbid];try{M(L);}catch(K){}}}},this));},__send:function(F,H,G,E){switch(this.get("transport")){case"wpm":try{H.postMessage(F,E);}catch(D){if(!this._pmRetry){this._pmRetry=true;C.later(100,this,function(){this.__send(F,H,G,E);});}else{this._initializationFailure();}return;}this._pmRetry=false;break;case"ifh":this.callIfpc(F,G);break;}},ajax:function(K,F,D,J,H){if(C.Lang.isUndefined(K)||C.Lang.isUndefined(F)){return;}var G,I=C.guid("xframereq_"),E=false;if(window.XMLHttpRequest){G=new XMLHttpRequest();}else{G=new ActiveXObject("Microsoft.XMLHTTP");
}G.open(K,this.get("api")+F,true);G.setRequestHeader("Content-Type","application/json;charset=utf-8");G.setRequestHeader("X-Yahoo-Msgr-User-Agent","YahooMessenger/1.0 (Mail Messenger;1.0.0.0)");this._pendingRequests[I]={};this._pendingRequests[I].request=G;G.onreadystatechange=C.bind(function(){try{var L=4;if(G.readyState==L&&!E){E=true;var P="{}",O="status unavailable";try{O=G.statusText;}catch(N){}if(G.status>=200&&G.status<210){P=G.responseText;}else{if((G.status==0)||(G.status>1000)){P=C.JSON.stringify({error:{code:800,detail:"Network error"},httpStatus:G.status,responseText:G.responseText||""});}else{P=C.JSON.stringify({error:{},httpStatus:G.status,detail:O,responseText:G.responseText||""});}}J(P);}}catch(M){try{J(C.JSON.stringify({error:{code:600,detail:"internal Xframe error"}}));}catch(N){}}if(E){clearTimeout(this._pendingRequests[I].timer);delete this._pendingRequests[I];G.onreadystatechange=null;G.abort=null;G=null;}},this);this._pendingRequests[I].timer=setTimeout(C.bind(function(){if(G){G.onreadystatechange=null;try{G.abort();}catch(L){}G.abort=null;G=null;}if(this._pendingRequests[I]){delete this._pendingRequests[I];}J({error:{code:700,detail:"Client Side Timeout"}});},this),(H||1800)*1000);G.send(D||"");},cancelRequests:function(){if(!this._destroyed&&this.get("transport")==="wpm"){var E=this.get("proxyWindow");if(!E){return;}var D=C.JSON.stringify({command:"cancelRequests",key:this.get("remoteKey")});this.__send(D,E,null,this.get("proxy"));}},_cancelRequests:function(){var F,D;for(F in this._pendingRequests){if(this._pendingRequests.hasOwnProperty(F)){D=this._pendingRequests[F];try{D.request.abort();}catch(E){}D.timer&&clearTimeout(D.timer);}}this._pendingRequests={};},_initializationFailure:function(){while(this._sendQueue.length){var D=this._sendQueue.shift();D.callback({error:{code:701,detail:"Xframe initialization error"}});}this._fatalError=true;},_retryIframeLoad:function(){if(this.get("transport")=="wpm"&&!this._destroyed&&!this._connectionEstablished){var D=this.get("iframe");if(D){this._destroyIframe(D);}this._iframeRetryCounter++;var E=this.emitInvisibleIframe(this._url,this.get("proxyName"));this.set("iframe",E);}},emitInvisibleIframe:function(D,E){var I,N=D,O;this._iframeRetryCounter=this._iframeRetryCounter||0;if(this._iframeRetryCounter===1){var F=N.indexOf("?"),L=N.indexOf("#");if(F>-1&&F<L){N=N.split(N.substring(F,L)).join("");this._src=N;}}else{if(this._iframeRetryCounter>4){this._initializationFailure();return;}}if(!E){for(var J=this._iframePool.length-1;J>=0;--J){var H=this._iframePool[J];try{if(H&&(H.recyclable||H.readyState==="complete")){H.parentNode.removeChild(H);if(window.ActiveXObject){this._destroyIframe(H);this._iframePool[J]=H=null;this._iframePool.splice(J,1);}else{H.recyclable=false;I=H;break;}}}catch(K){}}}if(!I){var G=document.createElement("div"),M='<iframe id="'+(E||"")+'" style="visibility:hidden;position:absolute;border:none;height:0px;width:0px;left:-9999px;"></iframe>';G.innerHTML=M;I=G.firstChild;if(!E){this._ieCraziness=true;this._iframePool.push(I);}}this._listeners.push(C.on("load",function(){if(!this._destroyed){if(this.iframe_onloadfired_timeout){this.iframe_onloadfired_timeout.cancel();this.iframe_onloadfired_timeout=null;this._iframe_loaded=true;}if(this._ieCraziness){this.recyclable=true;}if(!this._connectionEstablished&&!this._destroyed){this.iframe_load_timeout=C.later(5000,this,function(){this._retryIframeLoad();});}}},I,this));this._listeners.push(C.on("error",function(){if(!this._connectionEstablished&&!this._destroyed&&!this._iframe_loaded){this._retryIframeLoad();}},I,this));C.later(0,this,function(){if(!this._destroyed){I.src=N;document.body.appendChild(I);if(!this.iframe_onloadfired_timeout){O=3000+this._iframeRetryCounter*1000;this.iframe_onloadfired_timeout=C.later(O,this,function(){if(!this._destroyed&&!this._iframe_loaded){this._retryIframeLoad();}});}}});return I;},callIfpc:function(H,E,L,M,N){if(!L){if(H.length>B){var J=[],I,G;while(H.length>B){J.push(H.substr(0,B));H=H.substr(B);}J.push(H);G=J.length;for(I=0;I<G;I++){this.callIfpc(J[I],E,true,I,G);}return;}}var F=this.get("remoteRelay"),K=this.get("isProxy"),O=K?"..":this.get("proxyName"),P=this.get("remoteId");if(!F){}M=M||0;N=N||0;var D=[F,"#",O,"&",P,"&",M,"&",N,"&",encodeURIComponent(H)].join("");this.emitInvisibleIframe(D);},_destroyIframe:function(E){var F=this.get("transport");try{if(E.destroy){E.remove();if(F=="wpm"){E.set("src","");}E.destroy();}else{if(E.parentNode){E.parentNode.removeChild(E);}if(F=="wpm"){E.src="";}}}catch(D){}},sendLogoutURL:function(D){if(!this._destroyed&&this.get("transport")=="wpm"){var F=this.get("proxyWindow");if(!F){C.later(5000,this,function(){this.sendLogoutURL(D);});return;}var E=C.JSON.stringify({logoutURL:D,key:this.get("remoteKey")});this.__send(E,F,null,this.get("proxy"));}},_logoutOnUnload:function(D){var F=this.get("logoutURL"),H;if(F){if(typeof XMLHttpRequest!="undefined"){H=new XMLHttpRequest();}else{if(window.ActiveXObject){try{H=new ActiveXObject("MSXML2.XMLHttp.6.0");}catch(E){}}}if(!H){return;}H.open("get",F,false);H.setRequestHeader("X-Yahoo-Msgr-User-Agent","YahooMessenger/1.0 (Mail Messenger;1.0.0.0)");H.timeout=3000;try{H.send(null);}catch(G){}C.later(3000,this,function(){H.abort();});}}});C.namespace("Messenger").Xframe=A;},"@VERSION@",{requires:["json","base-base"]});