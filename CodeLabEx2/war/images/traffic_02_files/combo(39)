YUI.add("conversationapi",function(A){if(!YUI.namespace("Messenger").ConversationAPI){var C=window.launchData,G=A.Messenger.RequestManager,E=A.Messenger.SessionManager,D=A.Messenger.GlobalConfig,I=A.Messenger.Events,B=A.Messenger.ContactsManager,F=A.Messenger.CommonUtils;function H(J){H.superclass.constructor.apply(this,arguments);}H.ATTRS={};H.REQUESTS={SEND_MSG:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=send-message"]},SEND_SMS:{method:"POST",path:"/v1/message/sms/{{number}}"},CLOSE_CONV:{method:"POST",path:"/v1/messages",args:["action=close-conv","blocking=0"]},ACK_CONV:{method:"POST",path:"/v1/messages",args:["action=ack-conv","blocking=0"]},SET_TYPING_STATE:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=start-typing"]},CLEAR_TYPING_STATE:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=stop-typing"]},RECENT_MESSAGES_IM:{method:"POST",path:"/v1/message/{{network}}/{{user}}",args:["action=fetch-recent","count=50"]},RECENT_MESSAGES_SMS:{method:"POST",path:"/v1/message/sms/{{number}}",args:["action=fetch-recent","count=50"]}};A.extend(H,A.Base,{initializer:function(J){this._messageQueues={};A.later(0,this,function(){G.addListeners([{id:"message",callback:A.bind(this._processIncomingIM,this)},{id:"typing",callback:A.bind(this._processTyping,this)},{id:"offlineMessage",callback:A.bind(this._processOfflineMessages,this)},{id:"sms",callback:A.bind(this._processIncomingSMS,this)},{id:"recentMessages",callback:A.bind(this._processRecentMessages,this)},{id:"imSession",callback:A.bind(function(K){K.sessioninfo=[{network:K.network||"yahoo",sender:K.sender,receiver:K.receiver,messageCount:K.messageCount}];this._processIMSessions(K);},this)},{id:"imSessions",callback:A.bind(this._processIMSessions,this)},{id:"stateTransfer",callback:A.bind(this._processStateXfer,this)}]);});A.Global.on(I.ACK_CONVERSATION,A.bind(this.ackConversation,this));},sendMessage:function(L,N,M,O){var K={convId:F.getConversationId(O,L,N),txnId:[O,(new Date()).getTime(),Math.floor(Math.random()*9+1)].join("~"),message:M,sendAs:O};if(!this._messageQueues[K.convId]){this._messageQueues[K.convId]=[];}var J={network:N,user:L,body:K,type:"im"};this._messageQueues[K.convId].push(J);if(this._messageQueues[K.convId].length===1){this._sendNextMessage(K.convId);}this._processIncomingIM({msg:M,isNew:true,network:N,sender:O,receiver:L,timeStamp:Math.floor(+new Date/1000),echo:true});},sendSMS:function(L,O,N,M,Q){var P=F.normalizeNumber(N),K={convId:F.getConversationId(Q,L,O),txnId:[Q,(new Date()).getTime(),Math.floor(Math.random()*9+1)].join("~"),message:M,sendAs:Q};if(!P){A.Global.fire(I.MESSAGE_SEND_ERROR,{user:L,number:N,network:O,message:M,convId:K.convId});return;}if(!this._messageQueues[K.convId]){this._messageQueues[K.convId]=[];}var J={normalized_number:P,body:K,number:N,network:O,user:L,type:"sms"};this._messageQueues[K.convId].push(J);if(this._messageQueues[K.convId].length===1){this._sendNextMessage(K.convId);}this._processIncomingSMS({msg:M,isNew:true,network:"sms",sender:Q,receiver:L,normalizedNumber:P,number:N,timeStamp:Math.floor(+new Date/1000),echo:true});},setTypingState:function(M,K,N){var L=H.REQUESTS.SET_TYPING_STATE,J={};if(M){J.sendAs=M;}J.action="start-typing";G.issueRequest({method:L.method,args:L.args,path:F.substitute(L.path,{user:encodeURIComponent(K),network:N||"yahoo"}),postBody:J});},clearTypingState:function(M,K,N){var L=H.REQUESTS.CLEAR_TYPING_STATE,J={};if(M){J.sendAs=M;}J.action="stop-typing";G.issueRequest({method:L.method,args:L.args,path:F.substitute(L.path,{user:encodeURIComponent(K),network:N||"yahoo"}),postBody:J});},ackConversation:function(M){var J=M.user,L=M.network||"yahoo",K=M.alias;this._pendingConvAcks=this._pendingConvAcks||{};if(E.isPrimary()){this._pendingConvAcks[F.getConversationId(K,J,L)]={sender:K,receiver:J,network:L};if(!this._pendingAckTimer){this._pendingAckTimer=A.later(5000,this,function(){var N=H.REQUESTS.ACK_CONV;this._pendingAckTimer=null;var O=[];for(var P in this._pendingConvAcks){if(this._pendingConvAcks.hasOwnProperty(P)){O.push(this._pendingConvAcks[P]);}}if(O.length&&E.isOnline()){G.issueRequest({method:N.method,args:N.args,path:N.path,postBody:{convs:O}});}this._pendingConvAcks={};});}}},sendCloseConversation:function(L,J,M){M=M||"yahoo";var K=H.REQUESTS.CLOSE_CONV;G.issueRequest({path:K.path,method:K.method,args:K.args,postBody:{convs:[{sender:L,receiver:J,network:M}]}});},loadRecentMessages:function(M,K,O,N){var L,P,J;if(N=="sms"){this._pendingRecentMsgs="sms";L=H.REQUESTS.RECENT_MESSAGES_SMS;P=F.substitute(L.path,{number:B.getContact(K,O).mobileno});}else{this._pendingRecentMsgs="im";L=H.REQUESTS.RECENT_MESSAGES_IM;P=F.substitute(L.path,{user:encodeURIComponent(K),network:O||"yahoo"});}G.issueRequest({path:P,args:L.args,method:L.method});},_sendNextMessage:function(M){if(this._messageQueues[M].length===0){return;}var L=this._messageQueues[M][0],J,K;if(L.type=="im"){J=H.REQUESTS.SEND_MSG;K=F.substitute(J.path,{user:encodeURIComponent(L.user),network:L.network||"yahoo"});}else{if(L.type=="sms"){J=H.REQUESTS.SEND_SMS;K=F.substitute(J.path,{number:L.normalized_number});}}G.issueRequest({method:J.method,path:K,postBody:L.body,successCallback:A.bind(function(N){this._messageQueues[M].shift();this._sendNextMessage(M);},this),errorCallback:A.bind(function(N){A.Global.fire(I.MESSAGE_SEND_ERROR,{convId:M,message:L.message,user:L.user,network:L.network});this._messageQueues[M].shift();this._sendNextMessage(M);},this)});A.Global.fire(I.MESSAGE_SENT,{user:L.user,network:L.network});},_processIncomingIM:function(M){if(M&&M.fbecho){M.echo=M.fbecho;}var K=M.echo?M.sender:M.receiver,J=M.echo?M.receiver:M.sender,L=M.network||"yahoo",N=F.getConversationId(K,J,L);M.convId=N;M.user=J;M.network=L;M.alias=K;M.type=M.type||"message";A.Global.fire(I.MESSAGE_RECEIVED,M);},_processIncomingSMS:function(J){J.network="sms";J.type="sms";J.normalizedNumber=J.normalizedNumber||J.sender;this._processIncomingIM(J);},_processRecentMessages:function(N){var M=N.messageList,L,J,O,K;
for(L=0,J=M.length;L<J;L++){O=M[L].message;O.echo=E.isSelfUser(O.sender)?true:false;O.type=this._pendingRecentMsgs;O.isRecent=true;this._processIncomingIM(O);}},_processTyping:function(O){var L=O.sender,M=O.receiver,N=O.network||"yahoo",J,K=O.activity===1?true:false;if(N=="facebook"){J=B.getContact(L,N);if(J&&J.presence.state==-1){return;}}A.Global.fire(I.TYPING_NOTIFICATION,{convId:F.getConversationId(M,L,N),isTyping:K});},_processOfflineMessages:function(N){var M=N.messages,K,J,L;for(K=0,J=M.length;K<J;K++){L=M[K].message;L.offlineMessage=true;this._processIncomingIM(L);}},_processStateXfer:function(N){var M=N.messageList,K,J,L;for(K=0,J=M.length;K<J;K++){if(M[K].message){L=M[K].message;L.stateXferMessage=true;this._processIncomingIM(L);}else{if(M[K].sms){L=M[K].sms;L.stateXferMessage=true;this._processIncomingSMS(L);}}}},_processIMSessions:function(O){var Q=O.sessionInfo,M,J=Q.length,K,L,N,P;for(M=0;M<J;M++){P=Q[M];L=P.sender;K=P.receiver;N=P.network||"yahoo";if(O.state==3){A.Global.fire(I.CONVERSATION_ACK_RECEIVED,{alias:L,user:K,network:N});}else{if(O.state==2){A.Global.fire(I.CLOSE_CONVERSATION,{alias:L,user:K,network:N});}}}}});YUI.Messenger.ConversationAPI=new H();}A.namespace("Messenger").ConversationAPI=YUI.Messenger.ConversationAPI;A.Command.registerModule("yim",A.Messenger.ConversationAPI);},"@VERSION@",{requires:["base-base","events","command","conversationmanager"]});YUI.add("conversationmanager",function(A){if(!YUI.namespace("Messenger").ConversationManager){var K=A.Messenger.Events,H=0,T=0,J=0,D,C=A.Messenger.CommonUtils,I=C.logRocketStats,F=YUI.namespace("Messenger.Metrics"),M=A.Messenger.SessionManager,L=A.Messenger.ContactsManager,B=A.Messenger.GlobalConstants,N=A.Messenger.GlobalConfig,P=A.Messenger.WindowAPI,S=A.Messenger.WindowManager,R=A.Messenger.Intl,G="mim-dragdropshim",O,Q={},E;S.addWindowDefinition("TabbedMessageWindow",{allowResize:true,showMaximize:true,allowMove:true,showClose:true,showMinimize:true,minHeight:325,minWidth:310,startHeight:400,startWidth:340,startPosition:{},cssClass:"tabbedmessagewindow conversation",elementTitle:C.substitute(R.get("str_window_title_conversation"),{str_cfg_branding_messenger:N.getGenericAppName()}),title:"",startMinimized:true,showPopOut:N.get("conversationPopOutSupported"),ariaRole:"application",contentClass:"Messenger.TabbedMessageWindow",requires:["tabbedmessagewindow"]});S.addWindowDefinition("ConversationWindow",{showChrome:false,cssClass:"conversationwindow conversation mailTab",elementTitle:C.substitute(R.get("str_window_title_conversation"),{str_cfg_branding_messenger:N.getGenericAppName()}),title:N.getAppName(),ariaRole:"application",contentClass:"Messenger.ConversationWindow",requires:["conversationwindow"]});S.addWindowDefinition("ReportAbuseDialog",{allowMove:true,allowResize:false,modal:true,startHidden:true,showMaximize:false,showMinimize:false,showClose:true,centerOnShow:true,startWidth:420,minWidth:420,startHeight:250,title:C.substitute(R.get("str_conv_report_abuse_title"),{str_cfg_branding_messenger:N.getGenericAppName()}),cssClass:"reportabusedialog yim_dialog",destroyOnHide:true,ariaRole:"application",requires:["reportabusedialog"],contentClass:"Messenger.ReportAbuseDialog"});S.addWindowDefinition("AddContactWindow",{store:false,hidden:false,showClose:true,showMinimize:false,showMaximize:false,allowMove:true,allowResize:false,centerOnShow:true,modal:true,startWidth:500,startHeight:220,title:R.get("str_cont_add_to_cont"),elementTitle:C.substitute(R.get("str_window_title_addcontact"),{str_cfg_branding_messenger:N.getGenericAppName()}),cssClass:"addcontactwindow yim_dialog",destroyOnHide:true,ariaRole:"application",requires:["addcontactwindow"],contentClass:"Messenger.AddContactWindow"});YUI.Messenger.ConversationManager=(function(){function V(W){V.superclass.constructor.apply(this,arguments);}V.NAME="yim-ConversationManager";V.ATTRS={transferInProgress:{value:false}};V.WINDOW_ID_PREFIX="conversation-window-";var U=K.CONVERSATION_EVENTS;A.extend(V,A.Base,{initializer:function(){this._eventHandles=[];this._windowEventHandles={};this._conversationWindows={};this._openConversations={};this._windowShim=null;this._pendingIncomingMessages={};this._ssaNotificationShown=false;this._attachEventListeners();},destructor:function(){for(var W=0;W<this._eventHandles.length;W++){this._eventHandles[W].detach();}this._eventHandles=null;A.each(this._windowEventHandles,function(X){for(var Y=0;Y<X.length;Y++){X[Y].detach();}},this);A.each(this._conversationWindows,function(X){X.destroy();},this);this._conversationWindows=null;},_attachEventListeners:function(){this._eventHandles.push(A.Global.on(K.MESSAGE_RECEIVED,A.bind(this.onMessageReceived,this)));this._eventHandles.push(A.Global.on(K.SHOW_CONVERSATION,A.bind(this.onConversationOpened,this)));this._eventHandles.push(A.Global.on(K.CLOSE_CONVERSATION,A.bind(this.onConversationClosed,this)));this._eventHandles.push(A.Global.on(K.CLOSE_CONV_PICKER,A.bind(this.onCloseConvPicker,this)));this._eventHandles.push(A.Global.on(K.CLOSE_GROUP_REQUEST_TAB,A.bind(this.onCloseAddreqTab,this)));this._eventHandles.push(A.Global.on(K.CLOSE_SELECTED_CONVERSATION_TAB,A.bind(this.onCloseSelectedConv,this)));this._eventHandles.push(A.Global.on(K.SELECT_NEXT_CONV_TAB,A.bind(this.onSelectNextConvTab,this)));this._eventHandles.push(A.Global.on(K.SELECT_PREV_CONV_TAB,A.bind(this.onSelectPrevConvTab,this)));this._eventHandles.push(A.Global.on(K.OPEN_CONV_PICKER,A.bind(this.openIMConvPicker,this)));this._eventHandles.push(A.Global.on(K.OPEN_SMS_CONV_PICKER,A.bind(this.openSMSConvPicker,this)));this._eventHandles.push(A.Global.on(K.MULTIPLE_CONTACT_AUTHORIZE_REQUEST,A.bind(function(W){this.handleMultipleAuthorizeRequest(A.JSON.stringify({data:W}));},this)));this._eventHandles.push(A.Global.on(K.YTOGO_WINDOW_POPOUT,this.handleConversationPop,this,true));this._eventHandles.push(A.Global.on(K.YTOGO_WINDOW_POPIN,this.handleConversationPop,this,false));this._eventHandles.push(N.after("convWindowStyleChange",this._handleWindowTypeChange,this));this._addConversationListeners();},_addConversationListeners:function(){A.each(U,function(X,W){this._eventHandles.push(A.Global.on(K[W],function(Y){this._handleConversationEvent(W,Y);},this));},this);},_handleConversationEvent:function(d,a){if(A.Lang.isArray(a)){for(var e=0;e<a.length;e++){this._handleConversationEvent(d,a[e]);}return;}var c=false,Y=U[d].scope,b=U[d].openConv,X,g,h,f=K[d],Z;if(Y=="id"){if(a.convId){g=this._openConversations[a.convId];if(g&&g.windowId){X=this._conversationWindows[g.windowId];}if(X){X.handleConversationEvent(d,a,a.convId);c=true;}}else{if(a.user&&a.network){a.alias=a.alias||a.receiver||M.get("loggedInId");if(a.alias){h=C.getConversationId(a.alias,a.user,a.network);g=this._openConversations[h];if(g&&g.windowId){X=this._conversationWindows[g.windowId];if(X){X.handleConversationEvent(d,a,h);c=true;}}}else{var W=M.get("aliases");for(Z=0;Z<W.length;Z++){h=C.getConversationId(W[Z],a.user,a.network);g=this._openConversations[h];if(g&&g.windowId){X=this._conversationWindows[g.windowId];if(X){X.handleConversationEvent(d,a,h);c=true;}}}}}}if(!c&&b){this.onConversationOpened({user:a.user,network:a.network,alias:a.alias||M.get("loggedInId"),openedBySelf:false},null,null,null,A.bind(function(){this._handleConversationEvent(d,a);},this));}}else{A.each(this._conversationWindows,function(i){i.handleConversationEvent(d,a);});}},_createConversationWindow:function(d,c){c=c||{};
var X=c.startHidden?true:false,b,Z,W=V.WINDOW_ID_PREFIX+H,Y=this,a,g="TabbedMessageWindow",f;function e(){var h=S.getWindow(W),i=h.get("contentObject");Y._conversationWindows[W]=i;Y._windowEventHandles[W]=[];Y._windowEventHandles[W].push(i.on(K.CLOSE_ALL_CONVERSATIONS,A.bind(Y.onCloseAllConversations,Y)));Y._windowEventHandles[W].push(i.on(K.START_CONVERSATION_DRAGDROP,A.bind(Y._startWindowDragDrop,Y)));if(N.get("tabDragDropSupported")&&!Y._windowShim&&h.get("windowType")=="iframe"){A.later(500,Y,function(){this._createDraggableWindowShim(S.getWindow(W).getDOMWindow());});}if(d){A.later(0,null,d,W);}}a={startHidden:X,height:c.height||400,width:c.width||340,startPosition:{left:c.left,top:c.top},startMinimized:X,windowType:c.windowType||N.get("convWindowStyle")};if(a.windowType=="mailTab"){g="ConversationWindow";if(c.user&&c.network){Z=L.getContact(c.user,c.network);if(Z&&Z.displayname){if(c.network=="facebook"&&c.user==Z.displayname){f=C.getConversationId(c.alias,c.user,c.network);if(this._pendingIncomingMessages[f]&&this._pendingIncomingMessages[f].length){a.title=this._pendingIncomingMessages[f][0].displayName?this._pendingIncomingMessages[f][0].displayName:N.getGenericAppName().toUpperCase();}else{a.title=N.getGenericAppName().toUpperCase();}}else{a.title=Z.displayname;}}else{a.title=N.getGenericAppName().toUpperCase();}}else{if(c.newConvWindow){a.title=R.get("str_new_conversation");}else{if(c.groupAddReq){a.title=R.get("str_conv_add_requests");}else{a.title=N.getGenericAppName().toUpperCase();}}}}if(window.openmail){if(!a.startPosition.top){a.startPosition.bottom=30;}if(!a.startPosition.left){if(!R.isRTL()){a.startPosition.right=185;}else{a.startPosition.left=185;}}}else{a.startPosition.top=a.startPosition.top||5;a.startPosition.left=a.startPosition.left||400;}S.createWindow({windowType:g,windowId:W,initParms:a,callback:e});H++;T++;return W;},_destroyConversationWindow:function(W,Z){var a=this._conversationWindows[W],Y=S.getWindow(W),X=Y?Y.get("windowType"):null;if(!this.get("transferInProgress")){if(X==="browserWindow"){I({key:"popOutWindowClosed",value:""});}else{if(X==="iframe"&&a.get("minimized")){I({key:"minimizedOverlayWndClosed",value:""});}}}if(a&&(Z||T>1||!Y||X!="iframe"||X!=N.get("convWindowStyle"))){S.removeWindowTitleToggle(W);if(this._windowEventHandles[W]){A.each(this._windowEventHandles[W],function(b){b.detach();});delete this._windowEventHandles[W];}S.destroyWindow(W);delete this._conversationWindows[W];T--;if(W===D){D=null;A.some(this._conversationWindows,function(c,b){if(c.get("visible")&&!c.minimized&&S.getWindow(b).get("windowType")!="mailTab"){D=b;c.focus();return true;}else{if(!D){D=b;}}});}}},getActiveWindow:function(){var W=null;if(D){W=this._conversationWindows[D];}return W;},_handleWindowTypeChange:function(W){var X=W.newVal,b=W.prevVal,Y,a,Z=[];for(Y in this._conversationWindows){if(this._conversationWindows.hasOwnProperty(Y)){a=S.getWindow(Y);if(a){if(a.get("visible")){if(a.get("windowType")==b){if(b=="mailTab"){Z.push(Y);}else{this._moveToNewWindow(Y,X);}}}else{this._destroyConversationWindow(Y,true);}}else{delete this._conversationWindows[Y];}}}if(Z.length){this._mergeToNewWindow(Z,X);}},openIMConversation:function(W){this.onConversationOpened({user:W.user,network:W.network,mode:"im",openedBySelf:true});},openSMSConversation:function(W){this.onConversationOpened({user:W.user,network:W.network,mode:"sms",openedBySelf:true});},onConversationOpened:function(p,Z,X,m,c){var e=p.alias,r=p.network||"yahoo",q=r=="yahoo"?C.getYidFromEmailAddr(p.user,r).value:p.user,l=p.convId,b,n,i,o=false,W={},h,k,j;p.user=q;if(this.createPending){if(Z){this.createPending=false;}else{A.later(50,this,this.onConversationOpened,arguments);return;}}if(!e){e=M.get("loggedInId");p.alias=e;}if(!l){l=C.getConversationId(e,q,r);p.convId=l;}if(!X){if(p.srcWindow&&p.srcWindow.indexOf(V.WINDOW_ID_PREFIX)===0){k=S.getWindow(p.srcWindow);if(k){if(k.get("windowType")!="mailTab"){X=p.srcWindow;}else{X="new";}}else{X=D||"new";}}else{X=D||"new";}}if(X!="new"){k=S.getWindow(X);h=k.get("windowType");i=this._conversationWindows[X];j=i?!i.isEmpty():false;}if(!this._openConversations[l]){this._openConversations[l]=p;p.startHidden=!p.openedBySelf;if(X==="new"||T===0||(h=="mailTab"&&j)||(!N.get("tabbedMessaging")&&!(T===1&&this._conversationWindows[D].getNumConversations()===0))){this.createPending=true;if(!p.openedBySelf&&h=="iframe"){b=this._createConversationWindow(A.bind(function(){if(!this._conversationWindows[b].get("minimized")){S.getWindow(b).minimize();}this.onConversationOpened(p,true,b,m);},this,p),p);}else{b=this._createConversationWindow(A.bind(this.onConversationOpened,this,p,true,b,m,null),p);}D=b;return;}}n=this._openConversations[l];var Y=(p.openedBySelf!==undefined)?p.openedBySelf:n.openedBySelf;if(n.windowId){b=n.windowId;}else{if(X&&X!=="new"){b=X;D=X;}else{b=D;}}i=this._conversationWindows[b];k=S.getWindow(b);if(Y&&k.get("minimized")){k.restore();o=true;}else{if(!k.get("visible")&&!Y&&!k.get("minimized")){k.minimize();}}if(!n.windowId){if(m){W.loadSessionState=false;}n.windowId=b;i.addConversation(n,W);J++;if(!this.get("transferInProgress")){I({key:"conversationOpened",value:""});if(J===1){I({key:"1stConversationOpened",value:""});}else{if(J===2){I({key:"2ndConversationOpened",value:""});}else{if(J>=3){I({key:"3rdOrMoreConvOpened",value:""});}}}if(n.openedBySelf){var a,g=L.getContact(n.user,n.network);if(g){a=g.presence.state;}if(a===undefined||a===-1){I({key:"convOpenedToOfflineContact",value:""});}}if(!F.sessionConvOpened){I({key:"sessionConvOpened",value:""});F.sessionConvOpened=true;}}}else{n.openedBySelf=p.openedBySelf;if(p.mode){i.getConversation(l).set("mode",p.mode);}}if(m){i.setConversationState(l,m);}if(!i.get("visible")){k.show();if(o){P.BeginMove(b);P.EndMove(b);}}else{if(Y&&!i.get("disabled")){k.bringToFront();if(i.selectConversation){i.selectConversation(l);}}}if(!this._ssaNotificationShown&&!N.get("ssaNotificationSeen")){var d=i.getConversation(l),f=this;d.showNotification({message:C.substitute(R.get("str_opt_msg_general_history_description"),{str_cfg_branding_messenger:N.getGenericAppName()}),type:B.NOTIFICATION_STATICTOP,important:false,closeHandler:function(){N.set("ssaNotificationSeen",true);
},buttons:[{label:C.substitute(R.get("str_conv_user_notification_ssa_button"),{str_cfg_branding_messenger:N.getGenericAppName()}),callback:function(s){N.set("ssaNotificationSeen",true);A.Global.fire(K.SHOW_WINDOW,"OptionsWindow");}}],id:B.SSA_NOTIFICATION,showclose:true,autoDestroy:true});this._ssaNotificationShown=true;}if(this._pendingIncomingMessages[l]){while(this._pendingIncomingMessages[l].length){this._processMessage(this._pendingIncomingMessages[l].shift());}delete this._pendingIncomingMessages[l];}if(c){c();}if(p.clearTransferFlag){this.set("transferInProgress",false);}},closeConversation:function(Y,W,Z,X){this.onConversationClosed({alias:Y,user:W,network:Z,skipServerNotify:X});},onConversationClosed:function(a){var Z=a.user,X=a.network,c=a.alias,f=C.getConversationId(c,Z,X),e=this._openConversations[f],d,W,b,Y;if(!e){log("Close conversation command received for a conversation that wasn't open - "+f);return;}d=this._conversationWindows[e.windowId];W=S.getWindow(e.windowId);b=W.get("windowType");Y=d.getNumConversations();if(b==="iframe"&&Y===1&&!d.isConversationPickerOpen()&&!d.isAddReqTabOpen()){W.hide();}if(!this.get("transferInProgress")){I({key:"conversationClosed",value:""});if(d.hasUnreadMsgs(f)){I({key:"unreadConvClosed",value:""});}}d.closeConversation(e);delete this._openConversations[f];J--;if(d.isEmpty()){this._destroyConversationWindow(e.windowId);}if(!a.skipServerNotify){A.Messenger.ConversationAPI.sendCloseConversation(c,Z,X);}},getConversationWindowId:function(W){return this._openConversations[W]?this._openConversations[W].windowId:null;},getConversation:function(X){var W=this.getConversationWindowId(X);return W?this._conversationWindows[W].getConversation(X):null;},handleMultipleAuthorizeRequest:function(X,Z){var W=Z||D,Y=null,b=W?this._conversationWindows[W]:null;try{if(A.Lang.isString(X)){X=A.JSON.parse(X);}}catch(a){return;}if(b){Y=b.get("windowType");}if(!W||(Y=="mailTab")){W=this._createConversationWindow(A.bind(this.handleMultipleAuthorizeRequest,this,X,W),{groupAddReq:true,startHidden:true,startMinimized:true,openedBySelf:false,flashTab:true});D=W;return;}b.openGroupRequestsWindow(X.data);if(!b.get("invisible")){S.showWindow(W);}},onMessageReceived:function(a){if(this.get("transferInProgress")){A.later(50,this,function(){this.onMessageReceived(a);});}var c,d,b;if(!a.echo){if(L.isBlockedNonContact(a.sender,a.network||"yahoo")){if(!L.get("ABDataReceived")){L.after("ABDataReceivedChange",A.bind(function(){this.onMessageReceived(a);},this));}else{}return;}else{if(L.isUserIgnored(a.sender,a.network||"yahoo")){return;}}}if(a.network=="sms"&&(!a.convId||!this._openConversations[a.convId])){a.convId=this._findConversationSMS(a);if(!a.convId){var W=L.findContactWithMobileNo(a.sender);if(W){a.sender=W.user;a.network=W.network;a.convId=C.getConversationId(a.receiver,a.sender,a.network);}}}d=a.convId;if(!this._openConversations[d]){var Y=a.echo?a.receiver:a.sender,Z=a.echo?a.sender:a.receiver,X={user:Y,network:a.network||"yahoo",alias:Z};this._pendingIncomingMessages[d]=[a];this.onConversationOpened(X);return;}else{if(this._pendingIncomingMessages[d]){this._pendingIncomingMessages[d].push(a);return;}else{this._processMessage(a);}}},_findConversationSMS:function(X){var Z,Y,W;for(Z in this._openConversations){if(this._openConversations.hasOwnProperty(Z)){Y=this._openConversations[Z];if(X.alias!=Y.alias){continue;}if(Y.network=="sms"){if(X.normalizedNumber==C.normalizeNumber(Y.user)){return Z;}}else{W=L.getContact(Y.user,Y.network);if(W&&W.mobileno&&C.normalizeNumber(W.mobileno)==X.normalizedNumber){X.user=W.user;X.network=W.network;return Z;}}}}},_processMessage:function(W){var Z=W.convId,Y=this._openConversations[Z],X=this._conversationWindows[Y.windowId];if(!X){return;}X.processMessage(Z,W);},onCloseAllConversations:function(a,W){var Z=this._conversationWindows[W],Y=Z.getOpenConversations(),X=this;S.getWindow(W).hide();if(Z.isConversationPickerOpen()){A.Global.fire(K.CLOSE_CONV_PICKER,W);}if(Z.isAddReqTabOpen()){A.Global.fire(K.CLOSE_GROUP_REQUEST_TAB,W);}A.each(Y,function(c,b){X.onConversationClosed({user:c.user,network:c.network,alias:c.alias});});},onCloseSelectedConv:function(W){var X=this._conversationWindows[W];if(X){if(X.closeSelectedConversation){X.closeSelectedConversation();}else{this.onCloseAllConversations(null,W);}}},onSelectNextConvTab:function(W){var X=this._conversationWindows[W];if(X){X.selectNextConversation();}},onSelectPrevConvTab:function(W){var X=this._conversationWindows[W];if(X){X.selectPrevConversation();}},onOpenConvPicker:function(W,Y){var X,Z;if(!W){W=D;}if(N.get("convWindowStyle")=="mailTab"){for(Z in this._conversationWindows){if(this._conversationWindows.hasOwnProperty(Z)){X=this._conversationWindows[Z];if(X.isConversationPickerOpen()){this._destroyConversationWindow(Z,true);if(W===Z){W=null;}break;}}}}if(!W||(S.getWindow(W).get("windowType")=="mailTab"&&!this._conversationWindows[W].isEmpty())){W=this._createConversationWindow(A.bind(function(){this.onOpenConvPicker(W,Y);},this),{newConvWindow:true});D=W;return;}X=this._conversationWindows[W];X.openConversationPicker(Y||"conversation");if(X.get("minimized")){S.getWindow(W).restore();}if(!X.get("visible")){S.showWindow(W);}},openIMConvPicker:function(W){if(!M.isOnline()){M.login(0,"",A.bind(function(){this.openIMConvPicker(W);},this));return;}this.onOpenConvPicker(W,"im");},openSMSConvPicker:function(W){if(!M.isOnline()){M.login(0,"",A.bind(function(){this.openSMSConvPicker(W);},this));return;}this.onOpenConvPicker(W,"sms");},onCloseConvPicker:function(W){var Y=null;for(var X in this._conversationWindows){Y=this._conversationWindows[X];if((Y._objType=="convpicker")||(Y._convPickerOpen==true)){Y.closeConversationPicker();if(Y.isEmpty()){S.getWindow(X).hide();this._destroyConversationWindow(X);}}}},onCloseAddreqTab:function(){var X=null;for(var W in this._conversationWindows){X=this._conversationWindows[W];if((X._objType=="groupadd")||(X._addReqTabOpen==true)){X.closeAddReqTab();if(X.isEmpty()){S.getWindow(W).hide();
this._destroyConversationWindow(W);}}}},closeAllConversations:function(){for(var W=0;W<this._openConversations.length;W++){this.closeConversation(this._openConversations[W].alias,this._openConversations[W].user,this._openConversations[W].network);}this._openConversations=[];},closeConversationPicker:function(W){A.Global.fire(K.CLOSE_CONV_PICKER,W);},isAddReqTabOpen:function(W){var Y=this._conversationWindows[W||D];if(Y){var X=Y.isAddReqTabOpen();if(X){return X;}}},_createDraggableWindowShim:function(Y){var X={id:G,store:false,startHidden:true,left:400,top:100,width:350,height:400,showChrome:false};function W(){var a=Y.document.getElementsByTagName("link"),Z=S.getWindow(G);this._windowShim=Z.getDOMWindow();YUI({win:this._windowShim}).use("node","commonutils","oui-window-modder",function(g){var f=g.config.doc,c=g.one(f.body),e=c._node.id,d=[];c.set("innerHTML","");c.setStyle("margin","0px");c.setStyle("opacity","0.6");c.setStyle("filter","alpha(opacity=60)");c.set("id","dragdrop-window");c.addClass(Y.document.body.className);c.removeClass("minimized");for(var b=0;b<a.length;b++){d.push(a[b].href);}Z.loadFiles(d,"css",function(){});});}S.createWindow({windowType:"dragdropshim",windowId:G,initParms:X,callback:A.bind(W,this),skipLoad:true});},_startWindowDragDrop:function(a,Y,X,f,e,b){var d=this,c=a.details[0],W=c.getDOMWindow();if(this.get("transferInProgress")){return;}this.set("transferInProgress",true);this._startX=Y;this._startY=X;this._poppedConvId=b;c.set("bringToFrontOnFocus",false);function Z(m){var h=m.left,l=m.top,i=h+m.width,k=l+m.height,j=h+f,g=l+e;Q[W.windowName]={left:h,top:l,right:i,bottom:k};O=S.getWindow(W.windowName).getBackingDiv();YUI({win:d._windowShim}).use("node",function(s){var r=s.one(s.config.doc.body),o=s.one(s.config.doc.head),q,p;r.set("innerHTML",W.document.body.innerHTML);r.all(".conversation-pane").remove();r.all(".yui3-yim-conversation-input").remove();r.all(".mode-tray").remove();r.all(".yui3-tab").setStyle("visibility","hidden");r.one(".yui3-tab-selected").setStyle("visibility","visible");P.MoveTo(G,j,g);P.SetSize(G,m.width,m.height);if(O){P.MakeTopMostDiv(O.windowName);P.Show(O.windowName);}P.Show(G);P.BeginMove(G);if(s.UA.gecko>0){q=d._windowShim.document;}else{if((s.UA.ie>0&&s.UA.ie<9)){q=W.document;p=d._windowShim.document;}else{q=d._windowShim;}}d._dragDropMoveListener=s.on("mousemove",d._handleDragDropMouseMove,q,d);d._dragDropMouseUpListener=s.on("mouseup",function(t){this._handleDragDropMouseUp(t,c);},q,d);if(O){var n=s.UA.ie?O.document:O;d._bgMoveListener=s.on("mousemove",d._handleDragDropMouseMove,n,d);d._bgMouseUpListener=s.on("mouseup",function(t){this._handleDragDropMouseUp(t,c);},n,d,c);}if(p){d._backupMoveListener=s.on("mousemove",d._handleDragDropMouseMove,p,d);d._backupUpListener=s.on("mouseup",function(t){this._handleDragDropMouseUp(t,c);},p,d);}c.hidePoppedOutTab();});}P.GetPosAndSize(W.windowName,Z);this._windowPositions={};A.each(this._conversationWindows,function(h,g){if(g!==W.windowName){P.GetPosAndSize(g,A.bind(function(i){this._windowPositions[g]=i;},this));}},this);},_handleDragDropMouseMove:function(W){var Y=(W._event.screenX-this._startX),X=(W._event.screenY-this._startY);P.Move(G,Y,X);},_handleDragDropMouseUp:function(W,a){var Y=W.clientX,X=W.clientY,Z=false;if(W.currentTarget._node!=this._windowShim.document&&W.currentTarget._node!=this._windowShim){Z=true;}this._processDragDropFinish(a,Y,X,Z);this._dragDropMoveListener.detach();this._dragDropMouseUpListener.detach();if(O){this._bgMoveListener.detach();P.Hide(O.windowName);}if(this._backupMoveListener){this._backupMoveListener.detach();}if(this._backupUpListener){this._backupUpListener.detach();}P.EndMove(G);},_processDragDropFinish:function(Y,a,Z,X){function W(f){var k=f.left+a,j=f.top+Z,h=0,i=Y.getDOMWindow().windowName,g=Q[i],c="new";if(X){k=g.left+a;j=g.top+Z;}if(Y.getNumConversations()>1&&g.left<=k&&k<=g.right&&g.top<=j&&j<=g.bottom){if(Y.getNumConversations()===1){P.MoveTo(i,f.left,f.top);}Y.restorePoppedOutTab();this.set("transferInProgress",false);}else{A.some(this._windowPositions,function(l,m){if(l.left<=k&&k<=(l.left+l.width)&&l.top<=j&&j<=(l.top+l.height)){if(l.zIndex){var n=parseInt(l.zIndex);if(n>h){h=n;c=m;}}else{c=m;return true;}}},this);if(c==="new"&&Y.getNumConversations()===1){P.MoveTo(i,f.left,f.top);Y.restorePoppedOutTab();this.set("transferInProgress",false);}else{var e=Y.getConversationState(this._poppedConvId),b=this._openConversations[this._poppedConvId],d={openedBySelf:true,user:b.user,network:b.network,alias:b.alias,left:f.left,top:f.top,width:f.width,height:f.height,clearTransferFlag:true,notificationsEnabled:false};this.closeConversation(d.alias,d.user,d.network,true);this.onConversationOpened(d,false,c,e);}I({key:"conversationDraggedOut",value:""});}P.Hide(G);Y.set("bringToFrontOnFocus",true);}P.GetPosAndSize(G,A.bind(W,this));},handleConversationPop:function(W,Z){var Y,X=(new Date()).getTime();if(Z){Y="browserWindow";}else{Y=N.get("convWindowStyle");if(Y=="browserWindow"){Y="iframe";}}if(A.Messenger.ExternalInterface){if(Z){I({key:"windowPoppedOut",value:""});}else{I({key:"windowPoppedIn",value:""});}}this._moveToNewWindow(W,Y);if(A.Messenger.ExternalInterface){if(Z){I({key:"conversationPopOutTime",value:((new Date()).getTime()-X)});}else{I({key:"conversationPopInTime",value:((new Date()).getTime()-X)});}}},_mergeToNewWindow:function(j,a){var h,f,b,k,g,Y,X,Z,e,d,W={conversations:[],unreadCounts:{}};this.set("transferInProgress",true);for(d=0;d<j.length;d++){h=j[d];f=this._conversationWindows[h];X=S.getWindow(h);if(f&&X){try{W.showGroupAddReqs=W.showGroupAddReqs||f.isAddReqTabOpen();W.convPickerMode=W.convPickerMode?W.convPickerMode:f.getConversationPickerMode();if(f.getSelectedTab){W.selectedTab=W.selectedTab||f.getSelectedTab();}W.unreadCounts=A.merge(W.unreadCounts,f.getUnreadCounts());b=f.getOpenConversations();for(k in b){if(b.hasOwnProperty(k)){Y=this._openConversations[k];W.conversations.push({state:f.getConversationState(k),parms:{openedBySelf:true,user:Y.user,network:Y.network,alias:Y.alias,notificationsEnabled:false}});
if(!Z){Z=Y.user;e=Y.network;}this.closeConversation(b[k].alias,b[k].user,b[k].network,true);}}if(W.convPickerMode){this.onCloseConvPicker(h);}if(W.showGroupAddReqs){this.onCloseAddreqTab(h);}}catch(c){this.set("transferInProgress",false);return;}}}g=this._createConversationWindow(A.bind(function(){D=g;this._transferConversationsToWindow(W,g,true);},this),{windowType:a,user:Z,network:e});},_moveToNewWindow:function(j,b){var g=this._conversationWindows[j],c,k,X={},h,Y,W=S.getWindow(j),Z,f,e;if(g&&W){this.set("transferInProgress",true);try{X.conversations=[];X.showGroupAddReqs=g.isAddReqTabOpen();X.convPickerMode=g.getConversationPickerMode();if(g.getSelectedTab){X.selectedTab=g.getSelectedTab();}X.unreadCounts=g.getUnreadCounts();c=g.getOpenConversations();for(k in c){if(c.hasOwnProperty(k)){Y=this._openConversations[k];X.conversations.push({state:g.getConversationState(k),parms:{openedBySelf:b=="mailTab"?false:true,user:Y.user,network:Y.network,alias:Y.alias,notificationsEnabled:false}});if(!Z){Z=Y.user;f=Y.network;}this.closeConversation(c[k].alias,c[k].user,c[k].network,true);}}if(X.convPickerMode){this.onCloseConvPicker(j);}if(X.showGroupAddReqs){this.onCloseAddreqTab(j);}if(b!="mailTab"){h=this._createConversationWindow(A.bind(function(){D=h;this._transferConversationsToWindow(X,h,true);},this),{windowType:b,user:Z,network:f});}else{var a=X.conversations.length;if(X.convPickerMode){this._createConversationWindow(A.bind(function(i){this._transferConversationsToWindow({convPickerMode:X.convPickerMode},i,a===0&&!X.showGroupAddReqs);},this),{windowType:b,newConvWindow:true});}if(X.showGroupAddReqs){this._createConversationWindow(A.bind(function(i){this._transferConversationsToWindow({showGroupAddReqs:true},i,a===0);},this),{windowType:b,groupAddReq:true});}for(e=0;e<a;e++){this._createConversationWindow(A.bind(function(m,l,i){this._transferConversationsToWindow({conversations:[m]},i,l===(a-1));},this,X.conversations[e],e),{windowType:b,user:X.conversations[e].parms.user,network:X.conversations[e].parms.network});}if(a===0&&!X.convPickerMode&&!X.showGroupAddReqs){this.set("transferInProgress",false);}}}catch(d){this.set("transferInProgress",false);}}},_transferConversationsToWindow:function(W,e,d){var X,b=S.getWindow(e).getDOMWindow(),c=this._conversationWindows[e],f,Y=0,a=W.conversations||[];X=A.one(b.document.body).one(".window-loading-div");X.removeClass("hidden");X.setStyle("display","");if(W.showGroupAddReqs){f=L.getPendingAddRequests();if(f&&f.length){c.openGroupRequestsWindow(f);Y++;}else{if(!a.length&&!W.convPickerMode){W.convPickerMode="im";}}}if(W.convPickerMode){c.openConversationPicker(W.convPickerMode);Y++;}for(var Z=0;Z<a.length;Z++){this.onConversationOpened(a[Z].parms,false,e,a[Z].state);Y++;}if(W.selectedTab&&Y>1){if(W.convPickerMode||W.showGroupAddReqs){A.later(100,this,function(){c.selectTab(W.selectedTab);c.setUnreadCounts(W.unreadCounts);});}else{c.selectTab(W.selectedTab);c.setUnreadCounts(W.unreadCounts);}}X.setStyle("display","none");if(d){this.set("transferInProgress",false);}c.focus();}});return new V();})();A.Command.registerModule("yim",YUI.Messenger.ConversationManager);}A.namespace("Messenger").ConversationManager=YUI.Messenger.ConversationManager;},"@VERSION@",{requires:["globalconfig","sessionmanager","contactsmanager","globalconstants"]});